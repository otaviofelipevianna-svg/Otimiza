<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Otimiza CRM - Online</title>
    
    <!-- Tailwind CSS (Visual) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel (Para processar o React) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            LayoutDashboard, Users, ShoppingBag, CreditCard, Wallet, 
            Plus, Trash2, Edit2, TrendingUp, CheckCircle, Clock, 
            MessageCircle, Play, Settings, LogOut, Lock, User, 
            WifiOff, AlertTriangle, X, ShieldAlert, Copy
        } from 'https://esm.sh/lucide-react@0.292.0';

        // --- FIREBASE (Versão Web) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot 
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        // --- CONFIGURAÇÃO ---
        const firebaseConfig = {
            apiKey: "AIzaSyDQ8ggMxe09e6qf92B-1lv3A6gCP-J33Js",
            authDomain: "otimiza-9e42f.firebaseapp.com",
            projectId: "otimiza-9e42f",
            storageBucket: "otimiza-9e42f.firebasestorage.app",
            messagingSenderId: "482070105168",
            appId: "1:482070105168:web:cf8aae2f888946f196d555",
            measurementId: "G-HNWMPJ468D"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- COMPONENTES ---
        const Card = ({ title, value, subtext, icon: Icon, trend }) => (
            <div className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm flex flex-col justify-between h-full">
                <div className="flex justify-between items-start mb-2">
                    <p className="text-gray-500 text-xs font-bold uppercase tracking-wider">{title}</p>
                    <div className={`p-2 rounded-lg ${trend === 'up' ? 'bg-green-50 text-green-600' : trend === 'down' ? 'bg-red-50 text-red-600' : 'bg-black text-white'}`}>
                        <Icon size={20} />
                    </div>
                </div>
                <div>
                    <h3 className="text-2xl font-bold text-gray-900">{value}</h3>
                    {subtext && <p className={`text-xs mt-1 ${trend === 'up' ? 'text-green-600' : trend === 'down' ? 'text-red-600' : 'text-gray-400'}`}>{subtext}</p>}
                </div>
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
            const baseStyle = "px-4 py-3 md:py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 active:scale-95 touch-manipulation disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-black text-white hover:bg-gray-800",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200",
                danger: "bg-red-50 text-red-600 hover:bg-red-100",
                outline: "border border-gray-300 text-gray-700 hover:bg-gray-50"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end md:items-center justify-center z-50 p-0 md:p-4 animate-in fade-in duration-200">
                    <div className="bg-white w-full md:rounded-2xl rounded-t-2xl md:max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 sticky top-0 z-10">
                            <h2 className="text-lg font-bold text-gray-900">{title}</h2>
                            <button onClick={onClose} className="p-2 bg-gray-200 rounded-full hover:bg-red-100 hover:text-red-600 transition-colors"><X size={18}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const StatusBadge = ({ status }) => {
            const styles = {
                'Negociação': 'bg-gray-100 text-gray-600 border-gray-200',
                'Em Processo': 'bg-blue-50 text-blue-600 border-blue-100',
                'Concluído': 'bg-green-50 text-green-600 border-green-100'
            };
            const Icon = { 'Negociação': MessageCircle, 'Em Processo': Clock, 'Concluído': CheckCircle }[status] || MessageCircle;
            return (
                <span className={`px-2 py-1 rounded-md text-[10px] uppercase font-bold border flex items-center gap-1 w-fit ${styles[status]}`}>
                    <Icon size={10} /> {status}
                </span>
            );
        };

        // --- TELA DE AJUDA PARA CONFIGURAÇÃO ---
        const PermissionErrorScreen = () => {
            const rules = `rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}`;
            
            const copyToClipboard = () => {
                // Cria um elemento textarea temporário
                const textArea = document.createElement("textarea");
                textArea.value = rules;
                
                // Evita que o textarea cause rolagem na página
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.position = "fixed";
                
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    // Tenta copiar usando o comando antigo mas confiável
                    const successful = document.execCommand('copy');
                    if(successful) {
                        alert("Código copiado! Agora cole no Firebase.");
                    } else {
                        throw new Error("Falha ao copiar");
                    }
                } catch (err) {
                    console.error('Erro ao copiar', err);
                    prompt("Não foi possível copiar automaticamente. Por favor, copie o código abaixo manualmente:", rules);
                }
                
                document.body.removeChild(textArea);
            };

            return (
                <div className="min-h-screen bg-red-50 flex items-center justify-center p-6">
                    <div className="bg-white max-w-2xl w-full rounded-2xl shadow-2xl p-8 border-l-8 border-red-500">
                        <div className="flex items-center gap-4 mb-6">
                            <div className="bg-red-100 p-3 rounded-full">
                                <ShieldAlert size={40} className="text-red-600" />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-gray-900">Acesso Bloqueado pelo Google</h1>
                                <p className="text-red-600 font-medium">Configuração necessária no Firebase</p>
                            </div>
                        </div>

                        <div className="space-y-4 text-gray-600 mb-8">
                            <p>O seu banco de dados Firebase está protegido e recusou a conexão. Siga os passos para liberar:</p>
                            
                            <ol className="list-decimal pl-5 space-y-2 text-sm font-medium text-gray-800">
                                <li>Acesse o <a href="https://console.firebase.google.com/" target="_blank" className="text-blue-600 underline">Console do Firebase</a>.</li>
                                <li>Entre no seu projeto <strong>otimiza-9e42f</strong>.</li>
                                <li>Vá em <strong>Criação</strong> &gt; <strong>Firestore Database</strong> &gt; Aba <strong>Regras (Rules)</strong>.</li>
                                <li>Apague tudo e cole o código abaixo:</li>
                            </ol>
                        </div>

                        <div className="bg-gray-900 text-gray-100 p-4 rounded-lg relative font-mono text-xs md:text-sm overflow-x-auto">
                            <button onClick={copyToClipboard} className="absolute top-2 right-2 flex items-center gap-1 bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs transition-colors cursor-pointer z-10">
                                <Copy size={12} /> Copiar
                            </button>
                            <pre className="whitespace-pre-wrap">{rules}</pre>
                        </div>

                        <div className="mt-8 text-center">
                            <p className="text-sm text-gray-500 mb-2">Após clicar em "Publicar" no Firebase, recarregue esta página.</p>
                            <button onClick={() => window.location.reload()} className="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-colors">
                                Já publiquei, tentar novamente
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP ---
        function App() {
            // Estado do Sistema
            const [systemError, setSystemError] = useState('');
            const [permissionError, setPermissionError] = useState(false);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [firebaseUser, setFirebaseUser] = useState(null);

            // Auth
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [loginForm, setLoginForm] = useState({ user: '', pass: '' });
            const [loginStatus, setLoginStatus] = useState({ msg: '', type: '' });

            // Dados
            const [users, setUsers] = useState([]);
            const [clients, setClients] = useState([]);
            const [purchases, setPurchases] = useState([]);
            const [subscriptions, setSubscriptions] = useState([]);
            const [withdrawals, setWithdrawals] = useState([]);

            const [activeTab, setActiveTab] = useState('dashboard');
            
            // UI
            const [modals, setModals] = useState({ client: false, purchase: false, sub: false, withdrawal: false });
            const [editingId, setEditingId] = useState(null);
            const initialForms = {
                client: { name: '', segment: '', works: '', charged: '', received: '', status: 'Negociação' },
                purchase: { item: '', price: '', installments: '1', category: 'Equipamento' },
                sub: { name: '', price: '' },
                withdrawal: { name: '', amount: '', description: '' },
                user: { user: '', pass: '' }
            };
            const [forms, setForms] = useState(initialForms);

            // Inicialização
            useEffect(() => {
                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));

                // 1. Tentar Autenticação Anônima
                signInAnonymously(auth).catch(error => {
                    console.error("Erro Auth:", error);
                    setSystemError(`Erro de Autenticação: ${error.code}. Verifique se "Anonymous Auth" está ativado.`);
                });

                // 2. Monitorar Auth State
                const unsubAuth = onAuthStateChanged(auth, user => {
                    setFirebaseUser(user);
                    if (!user) setSystemError("Desconectado do servidor.");
                });

                return () => unsubAuth();
            }, []);

            // Sincronização em Tempo Real
            useEffect(() => {
                if (!firebaseUser) return;

                const basePath = 'otimiza_crm/v1';

                const subscribe = (subCol, setter) => {
                    return onSnapshot(collection(db, basePath, subCol), 
                        (snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setter(data);
                            // Tenta criar admin apenas se a leitura for bem sucedida e estiver vazia
                            if (subCol === 'users' && data.length === 0) {
                                // Adiciona catch para evitar erro se permissão de escrita estiver negada mas leitura permitida (raro, mas possível)
                                addDoc(collection(db, basePath, 'users'), { user: 'Admin', pass: 'Admin', role: 'admin' }).catch(e => console.log('Init user skipped'));
                            }
                        }, 
                        (error) => {
                            // Silencia logs repetitivos se o erro de permissão já foi detectado
                            if (error.code === 'permission-denied') {
                                setPermissionError(true);
                            } else {
                                console.error(`Erro lendo ${subCol}:`, error);
                                setSystemError(`Erro de conexão: ${error.code}`);
                            }
                        }
                    );
                };

                const unsubs = [
                    subscribe('users', setUsers),
                    subscribe('clients', setClients),
                    subscribe('purchases', setPurchases),
                    subscribe('subscriptions', setSubscriptions),
                    subscribe('withdrawals', setWithdrawals)
                ];

                return () => unsubs.forEach(u => u());
            }, [firebaseUser]);

            // Handlers
            const handleLogin = (e) => {
                e.preventDefault();
                if (!isOnline && users.length === 0) return setLoginStatus({ msg: 'Sem internet.', type: 'error' });

                const found = users.find(u => u.user.toLowerCase() === loginForm.user.toLowerCase() && u.pass === loginForm.pass);
                
                if (found) {
                    setLoginStatus({ msg: 'Sucesso!', type: 'success' });
                    setTimeout(() => {
                        setCurrentUser(found);
                        setIsAuthenticated(true);
                        setLoginStatus({ msg: '', type: '' });
                    }, 500);
                } else {
                    setLoginStatus({ msg: 'Dados incorretos.', type: 'error' });
                }
            };

            const handleSave = async (type) => {
                if (!firebaseUser) return alert("Erro: Sem conexão com o banco.");
                
                const colName = type + 's';
                const payload = { ...forms[type] };
                const basePath = 'otimiza_crm/v1';
                
                ['price', 'amount', 'charged', 'received'].forEach(k => {
                    if (payload[k]) payload[k] = Number(payload[k]);
                });
                
                if (type === 'withdrawal' && !payload.date) payload.date = new Date().toLocaleDateString('pt-BR');

                try {
                    if (editingId) {
                        await updateDoc(doc(db, basePath, colName, editingId), payload);
                    } else {
                        await addDoc(collection(db, basePath, colName), { ...payload, createdAt: Date.now() });
                    }
                    closeModals();
                } catch (e) {
                    alert(`Erro ao salvar: ${e.message}`);
                }
            };

            const handleDelete = async (subCol, id) => {
                if (confirm('Excluir item?')) {
                    try { await deleteDoc(doc(db, 'otimiza_crm/v1', subCol, id)); } catch (e) { alert(e.message); }
                }
            };

            const handleAddUser = async () => {
                if (!forms.user.user || !forms.user.pass) return alert("Preencha tudo.");
                const exists = users.some(u => u.user.toLowerCase() === forms.user.user.toLowerCase());
                if (exists) return alert("Usuário já existe.");
                try {
                    await addDoc(collection(db, 'otimiza_crm/v1/users'), forms.user);
                    setForms({...forms, user: { user: '', pass: '' }});
                    alert("Usuário criado!");
                } catch(e) { alert(e.message); }
            };

            // Helpers UI
            const openModal = (type, item = null) => {
                setEditingId(item ? item.id : null);
                setForms(prev => ({ ...prev, [type]: item || initialForms[type] }));
                setModals(prev => ({ ...prev, [type]: true }));
            };
            const closeModals = () => setModals({ client: false, purchase: false, sub: false, withdrawal: false });
            const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

            // Cálculos
            const totalRec = clients.reduce((acc, c) => acc + (c.received || 0), 0);
            const totalExp = purchases.reduce((acc, i) => acc + (i.price || 0), 0) + 
                             withdrawals.reduce((acc, i) => acc + (i.amount || 0), 0) +
                             subscriptions.reduce((acc, i) => acc + (i.price || 0), 0);

            // --- RENDERIZAÇÃO ---
            
            if (permissionError) {
                return <PermissionErrorScreen />;
            }

            // TELA LOGIN
            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-black flex flex-col items-center justify-center p-6">
                        <div className="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8 fade-in">
                            <div className="text-center mb-6">
                                <div className="inline-flex p-4 bg-black rounded-full mb-3"><Lock className="text-white" size={24} /></div>
                                <h1 className="text-2xl font-bold">Otimiza CRM</h1>
                                <p className="text-gray-500 text-xs mt-1">Acesso Nuvem</p>
                            </div>
                            
                            {systemError && (
                                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-800 text-xs">
                                    <strong>Erro no Sistema:</strong> {systemError}
                                </div>
                            )}

                            <form onSubmit={handleLogin} className="space-y-4">
                                <input type="text" placeholder="Usuário" className="w-full p-3 border rounded-lg bg-gray-50" value={loginForm.user} onChange={e => setLoginForm({...loginForm, user: e.target.value})} />
                                <input type="password" placeholder="Senha" className="w-full p-3 border rounded-lg bg-gray-50" value={loginForm.pass} onChange={e => setLoginForm({...loginForm, pass: e.target.value})} />
                                {loginStatus.msg && <p className={`text-xs text-center font-bold ${loginStatus.type === 'error' ? 'text-red-500' : 'text-green-500'}`}>{loginStatus.msg}</p>}
                                <button type="submit" disabled={!isOnline && users.length === 0} className="w-full bg-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50">Entrar</button>
                            </form>
                            {!isOnline && <p className="text-center text-xs text-red-400 mt-4 flex justify-center gap-1"><WifiOff size={12}/> Offline</p>}
                        </div>
                    </div>
                );
            }

            // DASHBOARD
            return (
                <div className="flex flex-col md:flex-row h-screen bg-gray-50 fade-in overflow-hidden">
                    {/* Menu Desktop */}
                    <aside className="hidden md:flex w-64 bg-black text-white flex-col p-6 shadow-2xl z-20">
                        <div className="flex flex-col items-center mb-8">
                            <div className="text-2xl font-bold flex items-center gap-1">Otimiza<Play className="fill-white" size={20}/></div>
                            <p className="text-[10px] text-gray-400 uppercase tracking-widest mt-1">Vídeo & Produção</p>
                        </div>
                        <nav className="flex-1 space-y-2">
                            {[
                                { id: 'dashboard', label: 'Visão Geral', icon: LayoutDashboard },
                                { id: 'clients', label: 'Projetos', icon: Users },
                                { id: 'purchases', label: 'Compras', icon: ShoppingBag },
                                { id: 'subscriptions', label: 'Assinaturas', icon: CreditCard },
                                { id: 'team', label: 'Retiradas', icon: Wallet },
                                { id: 'settings', label: 'Ajustes', icon: Settings },
                            ].map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${activeTab === item.id ? 'bg-white text-black' : 'text-gray-400 hover:text-white'}`}>
                                    <item.icon size={18} /> {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="pt-4 border-t border-gray-800">
                            <p className="text-xs text-gray-500 mb-2">Olá, {currentUser.user}</p>
                            <button onClick={() => window.location.reload()} className="flex items-center gap-2 text-xs text-red-400 hover:text-red-300"><LogOut size={14}/> Sair</button>
                        </div>
                    </aside>

                    {/* Conteúdo */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative">
                        <header className="bg-white border-b px-6 py-4 flex justify-between items-center z-10 sticky top-0">
                            <h1 className="text-lg font-bold capitalize">{activeTab === 'dashboard' ? 'Visão Geral' : activeTab}</h1>
                            {systemError && <AlertTriangle className="text-red-500 animate-pulse" size={20} onClick={() => alert(systemError)} />}
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 pb-24 md:pb-8">
                            <div className="max-w-6xl mx-auto space-y-6">
                                {activeTab === 'dashboard' && (
                                    <>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <Card title="Faturamento" value={formatBRL(totalRec)} icon={TrendingUp} trend="up" />
                                            <Card title="Despesas" value={formatBRL(totalExp)} icon={ShoppingBag} trend="down" />
                                            <Card title="Lucro Líquido" value={formatBRL(totalRec - totalExp)} icon={Wallet} trend={(totalRec - totalExp) >= 0 ? 'up' : 'down'} />
                                            <Card title="Custo Fixo" value={formatBRL(subscriptions.reduce((a,i)=>a+(i.price||0),0))} icon={CreditCard} />
                                        </div>
                                        <div className="bg-white p-5 rounded-xl border shadow-sm">
                                            <h3 className="font-bold mb-4">Projetos Recentes</h3>
                                            {clients.slice(-5).reverse().map(c => (
                                                <div key={c.id} className="flex justify-between border-b py-2 last:border-0">
                                                    <div><p className="font-bold text-sm">{c.name}</p><StatusBadge status={c.status}/></div>
                                                    <span className="font-bold text-green-600 text-sm">{formatBRL(c.received)}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}

                                {['clients', 'purchases', 'subscriptions', 'withdrawals'].includes(activeTab) && (
                                    <div className="space-y-4">
                                        <div className="flex justify-end"><Button onClick={() => openModal(activeTab.slice(0, -1))}><Plus size={18}/> Novo</Button></div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            {(activeTab === 'clients' ? clients : activeTab === 'purchases' ? purchases : activeTab === 'subscriptions' ? subscriptions : withdrawals).map(item => (
                                                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border flex flex-col justify-between">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div><h3 className="font-bold">{item.name || item.item}</h3><p className="text-xs text-gray-500">{item.segment || item.category || 'Item'}</p></div>
                                                        {activeTab === 'clients' && <StatusBadge status={item.status} />}
                                                    </div>
                                                    <div className="flex justify-between items-end mt-2">
                                                        <p className={`font-bold ${activeTab === 'clients' ? 'text-green-600' : 'text-red-600'}`}>{activeTab === 'clients' ? formatBRL(item.received) : `-${formatBRL(item.price || item.amount)}`}</p>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => openModal(activeTab.slice(0, -1), item)} className="p-2 bg-gray-100 rounded text-blue-600"><Edit2 size={16}/></button>
                                                            <button onClick={() => handleDelete(activeTab + 's', item.id)} className="p-2 bg-red-50 rounded text-red-500"><Trash2 size={16}/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'settings' && (
                                    <div className="bg-white p-6 rounded-xl shadow-sm border space-y-4">
                                        <h3 className="font-bold flex items-center gap-2"><Users size={20}/> Equipe</h3>
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="Login" className="border p-2 rounded w-full" value={forms.user.user} onChange={e=>setForms({...forms, user:{...forms.user, user:e.target.value}})}/>
                                            <input type="text" placeholder="Senha" className="border p-2 rounded w-full" value={forms.user.pass} onChange={e=>setForms({...forms, user:{...forms.user, pass:e.target.value}})}/>
                                            <Button onClick={handleAddUser}>Criar</Button>
                                        </div>
                                        <div className="space-y-2 mt-4">
                                            {users.map(u => (
                                                <div key={u.id} className="flex justify-between p-3 border rounded items-center">
                                                    <span className="font-bold text-sm">{u.user}</span>
                                                    {users.length > 1 && <button onClick={() => handleDelete('users', u.id)} className="text-red-500"><Trash2 size={16}/></button>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Menu Mobile */}
                        <div className="md:hidden fixed bottom-0 w-full bg-white border-t flex justify-around p-2 pb-safe z-20 shadow-2xl">
                            {['dashboard', 'clients', 'purchases', 'settings'].map(id => {
                                const Icon = { dashboard: LayoutDashboard, clients: Users, purchases: ShoppingBag, settings: Settings }[id];
                                return <button key={id} onClick={() => setActiveTab(id)} className={`p-3 rounded-xl ${activeTab === id ? 'text-black' : 'text-gray-400'}`}><Icon size={24} /></button>;
                            })}
                        </div>
                    </main>

                    {/* Modais Simplificados */}
                    <Modal isOpen={modals.client} onClose={closeModals} title="Projeto">
                        <div className="space-y-3">
                            <input className="w-full border p-3 rounded" placeholder="Cliente" value={forms.client.name} onChange={e=>setForms({...forms, client:{...forms.client, name:e.target.value}})} />
                            <input className="w-full border p-3 rounded" placeholder="Segmento" value={forms.client.segment} onChange={e=>setForms({...forms, client:{...forms.client, segment:e.target.value}})} />
                            <div className="grid grid-cols-2 gap-2">
                                <input type="number" className="border p-3 rounded" placeholder="Cobrado" value={forms.client.charged} onChange={e=>setForms({...forms, client:{...forms.client, charged:e.target.value}})} />
                                <input type="number" className="border p-3 rounded" placeholder="Recebido" value={forms.client.received} onChange={e=>setForms({...forms, client:{...forms.client, received:e.target.value}})} />
                            </div>
                            <select className="w-full border p-3 rounded" value={forms.client.status} onChange={e=>setForms({...forms, client:{...forms.client, status:e.target.value}})}><option>Negociação</option><option>Em Processo</option><option>Concluído</option></select>
                            <Button onClick={()=>handleSave('client')} className="w-full justify-center">Salvar</Button>
                        </div>
                    </Modal>
                    
                    <Modal isOpen={modals.purchase} onClose={closeModals} title="Compra">
                        <div className="space-y-3">
                            <input className="w-full border p-3 rounded" placeholder="Item" value={forms.purchase.item} onChange={e=>setForms({...forms, purchase:{...forms.purchase, item:e.target.value}})} />
                            <input type="number" className="w-full border p-3 rounded" placeholder="Valor" value={forms.purchase.price} onChange={e=>setForms({...forms, purchase:{...forms.purchase, price:e.target.value}})} />
                            <select className="w-full border p-3 rounded" value={forms.purchase.category} onChange={e=>setForms({...forms, purchase:{...forms.purchase, category:e.target.value}})}><option>Equipamento</option><option>Software</option><option>Outros</option></select>
                            <Button onClick={()=>handleSave('purchase')} className="w-full justify-center">Salvar</Button>
                        </div>
                    </Modal>

                    <Modal isOpen={modals.sub} onClose={closeModals} title="Assinatura">
                        <div className="space-y-3">
                            <input className="w-full border p-3 rounded" placeholder="Nome" value={forms.sub.name} onChange={e=>setForms({...forms, sub:{...forms.sub, name:e.target.value}})} />
                            <input type="number" className="w-full border p-3 rounded" placeholder="Valor" value={forms.sub.price} onChange={e=>setForms({...forms, sub:{...forms.sub, price:e.target.value}})} />
                            <Button onClick={()=>handleSave('sub')} className="w-full justify-center">Salvar</Button>
                        </div>
                    </Modal>

                    <Modal isOpen={modals.withdrawal} onClose={closeModals} title="Retirada">
                        <div className="space-y-3">
                            <input className="w-full border p-3 rounded" placeholder="Nome" value={forms.withdrawal.name} onChange={e=>setForms({...forms, withdrawal:{...forms.withdrawal, name:e.target.value}})} />
                            <input type="number" className="w-full border p-3 rounded" placeholder="Valor" value={forms.withdrawal.amount} onChange={e=>setForms({...forms, withdrawal:{...forms.withdrawal, amount:e.target.value}})} />
                            <Button onClick={()=>handleSave('withdrawal')} className="w-full justify-center">Salvar</Button>
                        </div>
                    </Modal>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
